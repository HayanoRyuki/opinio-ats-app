# 候補者重複検知・統合

本ドキュメントは、Opinio ATS における  
**機能定義：候補者重複検知・統合（Candidate Deduplication）** を扱う。

---

## 機能の位置づけ
候補者重複検知・統合は、  
複数の応募チャネル・時点から流入する候補者情報を対象に、  
**同一人物である可能性を検知し、管理上の重複を防ぐための基盤機能**である。

本機能は、
- 候補者を評価するためのものではない
- 採否判断に影響を与えるものではない
- データの正確性と運用効率を守るためのもの

である。

---

## 背景と必要性
ATS においては、以下の理由で重複が必ず発生する。

- メール応募・媒体応募・エージェント推薦の併用
- 再応募・別職種応募
- 表記揺れ（氏名・メール・電話番号）
- 転職回数による連絡先変更

重複を放置すると、
- 候補者対応ミス
- 選考履歴の分断
- 正しい分析ができない

といった問題が発生する。

---

## 基本思想（重要）
- **自動で統合しない**
- 常に人が確認できる余地を残す
- 検知と統合を明確に分離する
- 元データは必ず保持する

---

## 重複の定義
以下の条件を組み合わせて、  
**同一人物である可能性**を判定する。

### 主な判定キー
- メールアドレス
- 電話番号
- 氏名 + 生年月日（任意）
- 外部ID（エージェントID等）

※ 単一条件では確定しない  
※ 組み合わせルールは設定可能

---

## 検知フェーズ

### 自動検知
- 候補者作成・取り込み時に実行
- 類似候補者を候補として提示
- スコアではなく **一致理由** を提示

---

### 表示内容（例）
- 一致した項目（メール一致 等）
- 候補者ID
- 作成日時
- 応募チャネル

---

## 統合フェーズ

### 統合の考え方
- 統合は **明示操作のみ**
- 一方を「正」とし、他方を参照として紐づける
- 完全削除は行わない

---

### 統合時の処理
- Candidate の主ID決定
- 応募（Application）の紐づけ統合
- メモ・評価・履歴の保持
- 統合履歴の記録

---

## データモデル（必須）

### CandidateDuplicateDetection
- detection_id
- base_candidate_id
- duplicate_candidate_id
- matched_fields
- detected_at
- status  
  （pending / confirmed / ignored）

---

### CandidateMergeLog
- merge_id
- primary_candidate_id
- merged_candidate_id
- merged_by
- merged_at
- merge_reason

---

## コントローラ設計

### CandidateDeduplicationController
- index  
  重複候補一覧
- show  
  詳細比較
- confirmMerge  
  統合実行
- ignore  
  無視（再検知しない）

---

## Service

### CandidateDeduplicationService
- 類似判定ロジック
- 検知理由生成
- 統合処理の一元管理

---

## 権限・制御
- 統合操作は管理者または権限保持者のみ
- 無視設定は記録する
- 自動統合は行わない

---

## ログ・監査
- 検知履歴を保持
- 統合操作は必ず AuditLog に記録
- 後から「なぜ統合されたか」を説明できる状態にする

---

## 他機能との関係
- 応募取り込み：  
  初期検知の起点
- 候補者管理：  
  正規候補者の一元管理
- 分析・レポート：  
  正規化後データを参照

---

## 本機能で「やらないこと」
- 自動マージ
- 候補者の優劣判断
- スコアリング
- データの完全削除

---

## 一文定義（迷ったとき用）
候補者重複検知・統合は、  
**同一人物を一人として扱うために、人が責任を持って整理するための機能である。**
