# 選考パイプライン管理

本ドキュメントは、Opinio ATS における **機能定義 2-2：選考パイプライン管理** を扱う。

## 機能の位置づけ
選考パイプライン管理は、  
**候補者と求人の関係性を「選考ステップ」という時系列で可視化するための中核機能**である。

Opinio ATS におけるパイプラインは、単なる進捗管理ではなく、  
**「どのような判断の連なりで現在地に至ったか」**を把握するための構造として設計される。

---

## 基本構造
- パイプラインは **求人ごとに定義**される
- 各候補者（正確には応募）は、必ず **1つのステップに属する**
- ステップ間の移動は、すべて **履歴として記録**される
- 現在地だけでなく、**過去にどこを通過したか**を常に参照できる

---

## 主な操作
- ステップ間の移動（ドラッグ & ドロップ等）
- 現在ステータスの把握
- 各ステップでの滞留時間の可視化
- ステップごとの候補者一覧表示

---

## 設計上の前提
以下は、本機能を進捗管理ではなく「判断構造」として扱うための前提である。

- ステップ移動は **合否や評価の確定を意味しない**
- 合否判断や理由は、必ず **別の記録として残す**
- 自動判定・自動除外は行わない
- 「進んだ／落とした」ではなく、  
  **「どの段階にあり、何を判断中か」**を表す

---

## データモデル（必須）

### Application
候補者と求人の関係性を表す中核モデル。

- application_id
- candidate_id
- job_id
- channel_type（D / M / A）
- current_step_id
- applied_at
- status

### SelectionStep
求人ごとの選考ステップ定義。

- selection_step_id
- job_id
- step_order
- step_type（書類 / 面接 / 最終 など）
- is_active

### StepTransition
ステップ移動履歴。

- step_transition_id
- application_id
- from_step_id
- to_step_id
- moved_by
- moved_at

---

## コントローラ設計

### ApplicationController
- show  
  応募（候補者 × 求人）の詳細表示

### PipelineController
- board  
  パイプライン全体表示
- move  
  ステップ移動処理
- history  
  ステップ移動履歴表示

---

## ビュー設計
- pipeline/board  
  求人別パイプライン画面（カンバン形式）
- applications/show  
  応募詳細（候補者情報＋選考状況）
- pipeline/history  
  ステップ遷移履歴一覧

---

## Controller / View 以外に必要な要素

### Service
#### PipelineTransitionService
- ステップ移動の正当性チェック
- 遷移履歴の保存
- 関連イベントの発火  

Controller に判断ロジックを持たせないため必須。

### Domain Event
- ApplicationStepChanged  

分析・通知・ログ用途のため、  
ステップ移動はイベントとして扱う。

### Policy
- ApplicationPolicy  

求人・候補者・担当者の関係に基づく操作制御。

---

## 他機能との関係
- 候補者管理：人物情報の参照元
- 評価・メモ：ステップとは独立して記録
- ダッシュボード：  
  - 滞留中候補者  
  - 停滞ステップ  
  を可視化
- 分析：歩留まり・リードタイム算出の基礎

---

## 本機能で「やらないこと」
以下は、Opinio ATS の思想に基づく設計判断である。

- 合否の自動確定
- ステップ移動による評価確定
- 点数・ランクの付与
- 処遇判断につながる判定ロジック

選考パイプラインは、  
**判断を促すための「構造」**であり、  
判断そのものを代替する仕組みではない。

---

## SoT（Single Source of Truth）との関係（重要）

選考パイプライン管理は、  
**SoT（Single Source of Truth）そのものではなく、SoT を参照して可視化するための構造層**である。

パイプラインが保持・更新するのは、
- 応募（Application）の現在位置
- ステップ間の遷移履歴

のみであり、  
**評価・判断・事実確定を担う層ではない。**

---

### パイプラインが SoT にならない理由
- ステップ移動は「判断の結果」ではなく「状態の遷移」である
- 同一ステップ内で複数の判断が存在しうる
- 判断理由や評価は、別責務で管理されるべきである

そのため、
**「どのステップにいるか」＝「どう判断されたか」ではない。**

---

### 判断との明確な分離
選考パイプライン上で起きる操作は、  
以下を **一切確定しない**。

- 合否
- 評価の正否
- 候補者の優劣
- 採用可否

これらは必ず、
- 評価（Evaluation）
- 採用判断ログ（Decision Log）

といった **SoT に接続する別記録**として扱われる。

---

### AI機能との関係（SoT 非接触）
AIスクリーニングや AI面接などの AI系機能は、
選考パイプライン上の **補助的な情報源** として利用されるが、

- AI によってステップが自動で移動することはない
- AI の出力によって SoT が更新されることはない
- AI の出力は判断そのものにはならない

パイプラインは、  
**AIの判断を実行する場所ではなく、人の判断を配置する場所**である。

---

### 設計上の一文定義
選考パイプライン管理は、  
**SoT を動かすための装置ではなく、  
SoT に基づく判断を時系列で並べるための構造である。**
