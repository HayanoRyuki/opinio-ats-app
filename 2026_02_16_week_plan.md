# 2/16 週計画：エージェント画面実装

## 概要
設計ドキュメント `10_agent_recommendation.md` に定義された機能を全て実装する。
期限：2/19（木）

---

## Day 1（2/17 火）：DB・モデル・バックエンド基盤

### Step 1: `agents` テーブル＋モデル作成
新規マイグレーション `create_agents_table`

| カラム | 型 | 説明 |
|--------|-----|------|
| id | bigint PK | |
| company_id | FK → companies | |
| agent_type | enum(human, ai) | エージェント種別 |
| name | string | 担当者名 |
| organization | string | エージェント会社名 |
| email | string nullable | 連絡先 |
| phone | string nullable | 電話 |
| notes | text nullable | メモ |
| is_active | boolean default true | 有効フラグ |
| timestamps | | |

**ファイル:**
- `database/migrations/2026_02_17_000001_create_agents_table.php`
- `app/Models/Agent.php`（リレーション: company, recommendations）

### Step 2: `recommendation_links` テーブル＋モデル作成
推薦と候補者/応募の紐付けテーブル

| カラム | 型 | 説明 |
|--------|-----|------|
| id | bigint PK | |
| recommendation_id | FK → recommendations | |
| candidate_id | FK → candidates | |
| application_id | FK → applications nullable | |
| linked_at | timestamp | |
| timestamps | | |

**ファイル:**
- `database/migrations/2026_02_17_000002_create_recommendation_links_table.php`
- `app/Models/RecommendationLink.php`

### Step 3: `recommendations` テーブルに `agent_id` カラム追加
既存の `agent_company_name`, `agent_name`, `agent_email` はそのまま残し（後方互換）、`agent_id` を nullable で追加。

**ファイル:**
- `database/migrations/2026_02_17_000003_add_agent_id_to_recommendations.php`
- `app/Models/Recommendation.php` 更新（agent リレーション追加）

### Step 4: AgentController（Web）
エージェント会社マスタの CRUD

| メソッド | ルート | 説明 |
|----------|--------|------|
| index | GET /agents | 一覧 |
| create | GET /agents/create | 新規作成フォーム |
| store | POST /agents | 保存 |
| show | GET /agents/{agent} | 詳細（推薦履歴含む） |
| edit | GET /agents/{agent}/edit | 編集 |
| update | PUT /agents/{agent} | 更新 |

**ファイル:**
- `app/Http/Controllers/Web/AgentController.php`
- `routes/web.php` にルート追加

### Step 5: RecommendationController（Web）
推薦情報の管理

| メソッド | ルート | 説明 |
|----------|--------|------|
| index | GET /recommendations | 推薦一覧 |
| show | GET /recommendations/{id} | 推薦詳細（原文含む） |
| link | POST /recommendations/{id}/link | 候補者紐付け |
| unlink | POST /recommendations/{id}/unlink | 紐付け解除 |
| archive | POST /recommendations/{id}/archive | アーカイブ |

**ファイル:**
- `app/Http/Controllers/Web/RecommendationController.php`
- `routes/web.php` にルート追加

### Step 6: RecommendationLinkService
- `link($recommendation, $candidateId, $applicationId = null)` — 紐付け
- `unlink($recommendation, $candidateId)` — 解除
- `findDuplicateRecommendations($recommendation)` — 重複推薦検出

**ファイル:**
- `app/Services/RecommendationLinkService.php`

---

## Day 2（2/18 水）：Vue フロントエンド

### Step 7: エージェント一覧ページ
`Pages/Agents/Index.vue`
- テーブル表示（会社名、担当者名、メール、種別、状態）
- 検索・フィルター（active/inactive）
- 「新規登録」ボタン
- 既存の Opinio カラーテーマ適用

### Step 8: エージェント作成/編集フォーム
`Pages/Agents/Create.vue` / `Pages/Agents/Edit.vue`
- フォーム: 会社名、担当者名、メール、電話、種別（human/ai）、メモ
- バリデーション
- 既存 DraftDetail.vue のスタイルパターンに合わせる

### Step 9: エージェント詳細ページ
`Pages/Agents/Show.vue`
- エージェント基本情報
- このエージェントからの推薦一覧（推薦履歴）
- 統計（推薦数、確定数、却下数）

### Step 10: 推薦一覧ページ
`Pages/Recommendations/Index.vue`
- テーブル表示（候補者名、エージェント、求人、ステータス、受信日）
- フィルター: ステータス、エージェント会社
- ソート: 受信日（新しい順/古い順）

### Step 11: 推薦詳細ページ
`Pages/Recommendations/Show.vue`
- 左カラム: 候補者名、エージェント情報、ステータスバッジ、アクションボタン
- 右カラム:
  - 推薦理由・マッチポイント・懸念点（設計思想: 断定的表現を強調しない）
  - 候補者基本情報
  - 候補者紐付けUI（検索→紐付け/解除）
  - 原文（raw_payload）表示（折りたたみ）

---

## Day 3（2/19 木）：統合・ナビゲーション・シーダー・テスト

### Step 12: ナビゲーション更新
`AppLayout.vue` の候補者メニュー配下に追加:
- 「エージェント」→ /agents
- 「推薦」→ /recommendations

### Step 13: シーダー更新
`AgentSeeder.php` — サンプルエージェント会社（リクルートエージェント、JACリクルートメント等）
`RecommendationSeeder.php` の更新 — agent_id を紐付け

### Step 14: 動作確認・修正
- マイグレーション実行して全画面の動作確認
- CRUD 全操作のテスト
- 推薦→候補者紐付けフローの確認
- エラーハンドリングの確認

---

## 新規ファイル一覧（計14ファイル）

**Backend（7）:**
1. `database/migrations/2026_02_17_000001_create_agents_table.php`
2. `database/migrations/2026_02_17_000002_create_recommendation_links_table.php`
3. `database/migrations/2026_02_17_000003_add_agent_id_to_recommendations.php`
4. `app/Models/Agent.php`
5. `app/Models/RecommendationLink.php`
6. `app/Http/Controllers/Web/AgentController.php`
7. `app/Http/Controllers/Web/RecommendationController.php`
8. `app/Services/RecommendationLinkService.php`
9. `database/seeders/AgentSeeder.php`

**Frontend（5）:**
10. `resources/js/Pages/Agents/Index.vue`
11. `resources/js/Pages/Agents/Create.vue`（Edit兼用も可）
12. `resources/js/Pages/Agents/Show.vue`
13. `resources/js/Pages/Recommendations/Index.vue`
14. `resources/js/Pages/Recommendations/Show.vue`

**既存ファイル変更（4）:**
- `app/Models/Recommendation.php` — agent リレーション追加
- `routes/web.php` — ルート追加
- `resources/js/Layouts/AppLayout.vue` — ナビ追加
- `database/seeders/DatabaseSeeder.php` — AgentSeeder呼び出し追加

---

## 設計上の注意点
- 推薦は「判断の材料であって、判断そのものではない」（設計原則を UI に反映）
- 懸念点・前提条件を推薦理由と同列で表示する
- raw_payload は必ず保持・閲覧可能にする
- `agent_company_name` 等の既存カラムは後方互換で残す
